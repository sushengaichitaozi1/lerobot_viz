<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeRobot Dataset Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink-strong: #0f172a;
            --ink-soft: #475569;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --surface: #ffffff;
            --surface-muted: #f8fafc;
        }

        body {
            font-family: "Manrope", "Segoe UI", sans-serif;
            background: radial-gradient(circle at 10% 20%, #e0f2fe 0%, #f8fafc 45%, #fef3c7 100%);
            color: var(--ink-strong);
        }

        h1, h2, h3, .brand-font {
            font-family: "Space Grotesk", "Manrope", sans-serif;
        }

        [v-cloak] { display: none; }

        .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5f5; border-radius: 999px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="h-screen overflow-hidden">
<div id="app" v-cloak class="h-full flex flex-col">
    <header class="bg-white/80 backdrop-blur border-b border-blue-100 h-16 flex items-center justify-between px-6 shadow-sm shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-bold brand-font">LR</div>
            <div>
                <h1 class="text-lg font-bold tracking-tight">LeRobot <span class="text-blue-600">Dataset</span></h1>
                <p class="text-[11px] text-slate-500">Episode Explorer v2.0</p>
            </div>
        </div>

        <div class="flex-1 max-w-xl px-6 hidden md:block">
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                <input
                    v-model="search"
                    type="text"
                    :placeholder="viewMode === 'datasets' ? '搜索 数据集 / 机器人 / 任务类型...' : '搜索 Episode ID / 机器人 / 任务类型...'"
                    class="w-full bg-slate-100 border border-transparent rounded-full py-2.5 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all text-sm"
                />
            </div>
        </div>

        <div class="flex items-center gap-3 text-xs text-slate-600">
            <div class="hidden lg:flex flex-col items-end">
                <span class="uppercase text-[10px] tracking-wider text-slate-400">API Base</span>
                <span class="font-mono text-[11px] text-slate-600 truncate max-w-[180px]">{{ apiBase }}</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-slate-200 shadow-sm">
                <span class="w-2 h-2 rounded-full" :class="token ? 'bg-emerald-500' : 'bg-slate-300'"></span>
                <span>{{ token ? (user ? user.username : 'Connected') : 'Offline' }}</span>
            </div>
            <button
                @click="openDatasetModal"
                :disabled="!token"
                class="px-3 py-1.5 rounded-full bg-slate-900 text-white hover:bg-slate-800 transition text-xs disabled:opacity-40 disabled:cursor-not-allowed"
            >
                添加数据集
            </button>
            <button @click="openAuth" class="px-3 py-1.5 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition text-xs">
                {{ token ? '切换账号' : '连接/登录' }}
            </button>
            <button v-if="token" @click="logout" class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 transition text-xs">
                登出
            </button>
        </div>
    </header>

    <section class="bg-white/70 backdrop-blur border-b border-slate-200 px-6 py-3 space-y-3">
        <div class="flex items-center gap-3">
            <div class="text-xs uppercase tracking-wider text-slate-400 font-bold">机器人种类</div>
            <div class="flex-1 overflow-x-auto scrollbar-thin">
                <div class="flex gap-2">
                    <button
                        @click="selectRobot(null)"
                        :class="chipClass(!selectedRobot)"
                        class="px-3 py-1.5 rounded-full text-xs border transition"
                    >全部</button>
                    <button
                        v-for="robot in robots"
                        :key="robot.id"
                        @click="selectRobot(robot)"
                        :class="chipClass(selectedRobot && selectedRobot.id === robot.id)"
                        class="px-3 py-1.5 rounded-full text-xs border transition"
                    >{{ robot.displayName || robot.name }}</button>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3" v-if="taskTypes.length">
            <div class="text-xs uppercase tracking-wider text-slate-400 font-bold">任务类型</div>
            <div class="flex-1 overflow-x-auto scrollbar-thin">
                <div class="flex gap-2">
                    <button
                        @click="selectTask(null)"
                        :class="chipClass(!selectedTask)"
                        class="px-3 py-1.5 rounded-full text-xs border transition"
                    >全部</button>
                    <button
                        v-for="task in taskTypes"
                        :key="task.id"
                        @click="selectTask(task)"
                        :class="chipClass(selectedTask && selectedTask.id === task.id)"
                        class="px-3 py-1.5 rounded-full text-xs border transition"
                    >{{ task.displayName || task.name }}</button>
                </div>
            </div>
        </div>
    </section>

    <section class="px-6 py-3 bg-white/50 border-b border-slate-200 text-xs text-slate-500 flex flex-wrap gap-4 items-center">
        <div class="flex items-center gap-2">
            <span class="text-slate-400">{{ viewMode === 'datasets' ? '总 Datasets:' : '总 Episodes:' }}</span>
            <span class="font-semibold text-slate-700">{{ displayTotal }}</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-slate-400">筛选:</span>
            <span class="font-semibold text-slate-700">
                {{ selectedRobot ? (selectedRobot.displayName || selectedRobot.name) : '全部机器人' }}
                <span v-if="selectedTask"> / {{ selectedTask.displayName || selectedTask.name }}</span>
            </span>
        </div>
        <div class="flex items-center gap-2" v-if="viewMode === 'episodes'">
            <span class="text-slate-400">当前:</span>
            <span class="font-semibold text-slate-700">
                {{ pageStart }}-{{ pageEnd }} / {{ total }}
            </span>
        </div>
        <div class="ml-auto flex gap-2" v-if="viewMode === 'episodes'">
            <button @click="backToDatasets" class="px-3 py-1 rounded border text-slate-600">
                返回数据集
            </button>
            <button @click="changePage(-1)" :disabled="page === 1" class="px-3 py-1 rounded border text-slate-600 disabled:opacity-40">
                上一页
            </button>
            <button @click="changePage(1)" :disabled="pageEnd >= total" class="px-3 py-1 rounded border text-slate-600 disabled:opacity-40">
                下一页
            </button>
        </div>
        <div class="ml-auto flex gap-2" v-else>
            <button @click="refreshDatasets" class="px-3 py-1 rounded border text-slate-600">
                刷新数据集
            </button>
        </div>
    </section>

    <main class="flex-1 flex overflow-hidden">
        <div class="flex-1 overflow-y-auto p-6">
            <div v-if="viewMode === 'datasets'" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4">
                <article
                    v-for="dataset in filteredDatasets"
                    :key="dataset.id"
                    @click="selectDataset(dataset)"
                    class="bg-white/90 border border-slate-200 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer overflow-hidden"
                >
                    <div class="p-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-sm text-slate-900">{{ dataset.name }}</h3>
                            <span class="text-[10px] px-2 py-1 rounded-full bg-emerald-50 text-emerald-700">
                                {{ dataset.episodeCount }} eps
                            </span>
                        </div>
                        <div class="text-xs text-slate-500">
                            <span>{{ dataset.robot || '未知机器人' }}</span>
                            <span class="mx-1">·</span>
                            <span>{{ dataset.taskType || '未知任务' }}</span>
                        </div>
                        <div class="text-[11px] text-slate-400 truncate">
                            {{ dataset.path }}
                        </div>
                    </div>
                </article>
            </div>
            <div v-else class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4">
                <article
                    v-for="item in filteredItems"
                    :key="item.id"
                    @click="selectItem(item)"
                    class="bg-white/90 border border-slate-200 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer overflow-hidden"
                >
                    <div class="aspect-video bg-slate-100">
                        <img
                            :src="item.thumbnailUrl"
                            alt="thumbnail"
                            class="w-full h-full object-cover"
                            @error="handleImageError"
                        />
                    </div>
                    <div class="p-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-sm text-slate-900">{{ item.episodeId || 'Episode' }}</h3>
                            <span class="text-[10px] px-2 py-1 rounded-full bg-blue-50 text-blue-700">
                                {{ item.cameraCount || 0 }} cams
                            </span>
                        </div>
                        <div class="text-xs text-slate-500">
                            <span>{{ item.robot }}</span>
                            <span class="mx-1">·</span>
                            <span>{{ item.taskType }}</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-slate-500">
                            <span>{{ formatDuration(item.duration) }}</span>
                            <span>{{ item.resolution }}</span>
                        </div>
                    </div>
                </article>
            </div>

            <div v-if="viewMode === 'datasets' && !filteredDatasets.length && !loading.items" class="text-center text-sm text-slate-400 py-16">
                暂无数据集，请先添加或索引数据集。
            </div>
            <div v-if="viewMode === 'episodes' && !filteredItems.length && !loading.items" class="text-center text-sm text-slate-400 py-16">
                暂无 Episodes，请先索引数据集。
            </div>
        </div>

        <aside
            v-if="selectedItem && !viewer.open"
            class="w-[380px] shrink-0 border-l border-slate-200 bg-white/90 backdrop-blur p-5 overflow-y-auto transition"
            :class="{'hidden lg:block': !selectedItem, 'hidden': !selectedItem && isMobile}"
        >
            <div v-if="selectedItem" class="space-y-4">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-lg font-bold">{{ detail?.episodeId }}</h2>
                        <p class="text-xs text-slate-500">{{ detail?.robot?.displayName || detail?.robot?.name }} - {{ detail?.taskType?.displayName || detail?.taskType?.name }}</p>
                    </div>
                    <button class="text-slate-400 hover:text-slate-600 lg:hidden" @click="closeDetail">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="bg-slate-900 rounded-xl overflow-hidden">
                    <video
                        v-if="videoUrl"
                        :src="videoUrl"
                        controls
                        autoplay
                        class="w-full h-auto"
                    ></video>
                    <div v-else class="aspect-video bg-slate-800"></div>
                </div>

                <div class="space-y-2">
                    <div class="text-xs uppercase tracking-wider text-slate-400">相机视角</div>
                    <div class="flex flex-wrap gap-2">
                        <button
                            v-for="cam in detail?.cameras || []"
                            :key="cam.cameraKey"
                            @click="switchCamera(cam.cameraKey)"
                            :class="chipClass(selectedCamera === cam.cameraKey)"
                            class="px-3 py-1.5 rounded-full text-xs border transition"
                        >{{ cam.displayName || cam.cameraKey }}</button>
                    </div>
                </div>

                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-xs text-slate-600 space-y-2">
                    <div class="flex justify-between"><span>帧数</span><span class="font-semibold text-slate-800">{{ detail?.totalFrames }}</span></div>
                    <div class="flex justify-between"><span>时长</span><span class="font-semibold text-slate-800">{{ formatDuration(detail?.duration) }}</span></div>
                    <div class="flex justify-between"><span>分辨率</span><span class="font-semibold text-slate-800">{{ detail?.width }}x{{ detail?.height }}</span></div>
                    <div class="flex justify-between"><span>图像总数</span><span class="font-semibold text-slate-800">{{ detail?.imageCount }}</span></div>
                    <div class="flex justify-between"><span>大小</span><span class="font-semibold text-slate-800">{{ formatBytes(detail?.totalSizeBytes) }}</span></div>
                </div>

                <div class="space-y-3">
                    <div class="text-xs uppercase tracking-wider text-slate-400">Rerun 可视化</div>
                    <div class="flex gap-2">
                        <button @click="generateRrd" class="flex-1 px-3 py-2 rounded-lg bg-blue-600 text-white text-xs hover:bg-blue-700">生成 .rrd</button>
                        <button @click="startRerunServer" class="flex-1 px-3 py-2 rounded-lg bg-slate-900 text-white text-xs hover:bg-slate-800">启动服务器</button>
                    </div>
                    <div v-if="rerunMessage" class="text-xs text-slate-600 bg-slate-100 rounded-lg p-3">
                        {{ rerunMessage }}
                    </div>
                </div>
            </div>
        </aside>
    </main>

        <div v-if="selectedItem && isMobile" class="fixed inset-0 bg-black/40" @click="closeDetail"></div>

    <div v-if="viewer.open" class="fixed inset-0 bg-black/60 z-50">
        <div class="absolute inset-0 bg-gray-50 text-gray-800 font-sans flex flex-col">
            <header class="h-10 bg-white border-b border-gray-300 flex items-center px-4 justify-between shrink-0">
                <div class="flex items-center gap-4">
                    <div class="font-bold text-sm tracking-tight flex items-center gap-2">
                        <div class="w-5 h-5 bg-black rounded-sm text-white flex items-center justify-center text-[10px]">R</div>
                        rerun.io
                    </div>
                    <div class="h-4 w-[1px] bg-gray-300"></div>
                    <div class="text-xs text-gray-500 truncate max-w-[380px]">{{ detail?.filePath || 'Dataset' }}</div>
                </div>
                <div class="flex items-center gap-3 text-gray-600">
                   <span class="text-xs">Share</span>
                   <i class="fas fa-cog text-[13px]"></i>
                   <button @click="closeViewer" class="text-gray-500 hover:text-gray-800">✕</button>
                </div>
            </header>

            <div class="flex flex-1 overflow-hidden">
                <div class="w-64 bg-gray-50 border-r border-gray-300 flex flex-col shrink-0">
                    <div class="p-2 border-b border-gray-200">
                        <div class="text-xs font-bold uppercase text-gray-500 mb-2">Recordings</div>
                        <div class="bg-blue-600 text-white text-xs p-1 px-2 rounded flex items-center justify-between">
                            <span class="truncate">{{ detail?.episodeId || 'Episode' }}</span>
                            <span class="text-[10px] opacity-80">{{ formatDuration(detail?.duration) }}</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto py-2">
                        <div class="text-xs font-bold uppercase text-gray-500 px-2 mb-1">Blueprint</div>
                        <div class="flex items-center gap-2 px-2 py-1 text-xs text-gray-700 hover:bg-gray-200 cursor-pointer">
                            <i class="fas fa-desktop text-[12px]"></i>
                            <span>Viewport (Grid)</span>
                        </div>
                        <div class="flex items-center gap-2 px-5 py-1 text-xs bg-blue-100 text-blue-700 cursor-pointer">
                            <i class="fas fa-wave-square text-[12px]"></i>
                            <span>action</span>
                        </div>
                        <div class="flex items-center gap-2 px-5 py-1 text-xs text-gray-700 hover:bg-gray-200 cursor-pointer">
                            <i class="fas fa-image text-[12px]"></i>
                            <span>observation.images.{{ viewer.primaryCamera || 'top' }}</span>
                        </div>
                        <div class="flex items-center gap-2 px-5 py-1 text-xs text-gray-700 hover:bg-gray-200 cursor-pointer" v-if="viewer.secondaryCamera">
                            <i class="fas fa-image text-[12px]"></i>
                            <span>observation.images.{{ viewer.secondaryCamera }}</span>
                        </div>
                        <div class="flex items-center gap-2 px-5 py-1 text-xs text-gray-700 hover:bg-gray-200 cursor-pointer">
                            <i class="fas fa-wave-square text-[12px]"></i>
                            <span>state</span>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-gray-100 p-1 overflow-hidden relative">
                    <div class="grid grid-cols-2 grid-rows-2 gap-1 h-full w-full">
                        <div class="flex flex-col bg-white border border-gray-300 h-full overflow-hidden">
                            <div class="flex items-center justify-between px-2 py-1 bg-gray-50 border-b border-gray-200 text-xs select-none">
                                <div class="flex items-center gap-2 text-gray-700 font-medium">
                                    <i class="fas fa-wave-square text-[12px] text-gray-500"></i>
                                    <span>action</span>
                                </div>
                                <div class="flex items-center gap-1 text-gray-400">
                                    <i class="fas fa-question-circle text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-eye text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-expand text-[12px] hover:text-gray-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 overflow-hidden relative p-2">
                                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <polyline :points="chartPoints('action', 0)" fill="none" stroke="#8884d8" stroke-width="0.8" vector-effect="non-scaling-stroke" />
                                    <polyline :points="chartPoints('action', 1)" fill="none" stroke="#82ca9d" stroke-width="0.8" vector-effect="non-scaling-stroke" />
                                    <polyline :points="chartPoints('action', 2)" fill="none" stroke="#ffc658" stroke-width="0.8" vector-effect="non-scaling-stroke" />
                                    <line :x1="viewerCursorX" y1="0" :x2="viewerCursorX" y2="100" stroke="#111827" stroke-width="0.6" vector-effect="non-scaling-stroke" />
                                </svg>
                                <div class="absolute bottom-2 left-2 flex flex-col gap-0.5 text-[10px] bg-white/80 p-1 rounded border border-gray-100 pointer-events-none">
                                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#8884d8]"></div> {{ viewer.actionNames[0] || 'joint_0' }}</div>
                                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#82ca9d]"></div> {{ viewer.actionNames[1] || 'joint_1' }}</div>
                                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#ffc658]"></div> {{ viewer.actionNames[2] || 'joint_2' }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col bg-white border border-gray-300 h-full overflow-hidden">
                            <div class="flex items-center justify-between px-2 py-1 bg-gray-50 border-b border-gray-200 text-xs select-none">
                                <div class="flex items-center gap-2 text-gray-700 font-medium">
                                    <i class="fas fa-image text-[12px] text-gray-500"></i>
                                    <span>observation.images.{{ viewer.primaryCamera || 'top' }}</span>
                                </div>
                                <div class="flex items-center gap-1 text-gray-400">
                                    <i class="fas fa-question-circle text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-eye text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-expand text-[12px] hover:text-gray-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 overflow-hidden relative bg-black">
                                <video
                                    v-if="viewer.primaryCamera"
                                    :src="videoUrlFor(viewer.primaryCamera)"
                                    controls
                                    autoplay
                                    muted
                                    playsinline
                                    @timeupdate="onPrimaryTimeUpdate"
                                    class="w-full h-full object-contain bg-black"
                                ></video>
                                <div v-else class="w-full h-full flex items-center justify-center text-gray-400">No camera</div>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
                                    <p class="text-white text-xs font-mono">{{ formatTimestamp(viewer.currentTime) }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col bg-white border border-gray-300 h-full overflow-hidden">
                            <div class="flex items-center justify-between px-2 py-1 bg-gray-50 border-b border-gray-200 text-xs select-none">
                                <div class="flex items-center gap-2 text-gray-700 font-medium">
                                    <i class="fas fa-image text-[12px] text-gray-500"></i>
                                    <span>observation.images.{{ viewer.secondaryCamera || 'wrist' }}</span>
                                </div>
                                <div class="flex items-center gap-1 text-gray-400">
                                    <i class="fas fa-question-circle text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-eye text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-expand text-[12px] hover:text-gray-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 overflow-hidden relative bg-black">
                                <video
                                    v-if="viewer.secondaryCamera"
                                    :src="videoUrlFor(viewer.secondaryCamera)"
                                    controls
                                    autoplay
                                    muted
                                    playsinline
                                    class="w-full h-full object-contain bg-black"
                                ></video>
                                <div v-else class="w-full h-full flex items-center justify-center text-gray-400">No secondary camera</div>
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
                                    <p class="text-white text-xs font-mono">{{ formatTimestamp(viewer.currentTime) }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col bg-white border border-gray-300 h-full overflow-hidden">
                            <div class="flex items-center justify-between px-2 py-1 bg-gray-50 border-b border-gray-200 text-xs select-none">
                                <div class="flex items-center gap-2 text-gray-700 font-medium">
                                    <i class="fas fa-wave-square text-[12px] text-gray-500"></i>
                                    <span>state</span>
                                </div>
                                <div class="flex items-center gap-1 text-gray-400">
                                    <i class="fas fa-question-circle text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-eye text-[12px] hover:text-gray-600"></i>
                                    <i class="fas fa-expand text-[12px] hover:text-gray-600"></i>
                                </div>
                            </div>
                            <div class="flex-1 overflow-hidden relative p-2">
                                <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                    <polyline :points="chartPoints('state', 0)" fill="none" stroke="#ff7300" stroke-width="0.8" vector-effect="non-scaling-stroke" />
                                    <polyline :points="chartPoints('state', 1)" fill="none" stroke="#00C49F" stroke-width="0.8" vector-effect="non-scaling-stroke" />
                                    <line :x1="viewerCursorX" y1="0" :x2="viewerCursorX" y2="100" stroke="#111827" stroke-width="0.6" vector-effect="non-scaling-stroke" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-72 bg-white border-l border-gray-300 flex flex-col shrink-0 text-xs">
                    <div class="p-2 bg-blue-50 border-b border-blue-100">
                        <h3 class="font-bold text-blue-900 mb-1">Selection</h3>
                        <div class="text-blue-700 truncate">{{ detail?.episodeId || 'Episode' }}</div>
                    </div>
                    <div class="p-0">
                        <div class="bg-gray-50 px-2 py-1 border-y border-gray-200 font-semibold flex items-center gap-1">
                            <i class="fas fa-chevron-down text-[10px]"></i> Data
                        </div>
                        <div class="p-2 space-y-2">
                            <div class="grid grid-cols-3 gap-2">
                                <span class="text-gray-500">Kind</span>
                                <span class="col-span-2">Recording</span>
                                <span class="text-gray-500">Duration</span>
                                <span class="col-span-2">{{ formatDuration(detail?.duration) }}</span>
                                <span class="text-gray-500">Size</span>
                                <span class="col-span-2">{{ formatBytes(detail?.totalSizeBytes) }}</span>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-2 py-1 border-y border-gray-200 font-semibold flex items-center gap-1 mt-4">
                            <i class="fas fa-chevron-down text-[10px]"></i> Properties
                        </div>
                        <div class="p-2">
                            <div class="flex items-center gap-2 font-mono text-green-700">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                fps: {{ detail?.fps || 30 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-32 bg-white border-t border-gray-300 shrink-0 flex flex-col">
                <div class="h-8 flex items-center px-2 gap-2 border-b border-gray-200 bg-gray-50">
                    <button class="p-1 hover:bg-gray-200 rounded"><i class="fas fa-step-backward text-[12px]"></i></button>
                    <button class="p-1 hover:bg-gray-200 rounded"><i class="fas fa-play text-[12px]"></i></button>
                    <button class="p-1 hover:bg-gray-200 rounded"><i class="fas fa-step-forward text-[12px]"></i></button>
                    <div class="h-4 w-[1px] bg-gray-300 mx-1"></div>
                    <span class="text-xs font-mono font-bold">timestamp</span>
                    <span class="text-xs text-gray-500">1.00x</span>
                    <span class="text-xs font-mono ml-4">{{ formatTimestamp(viewer.currentTime) }}</span>
                </div>
                <div class="flex-1 relative bg-white overflow-hidden">
                    <div class="absolute top-0 w-full h-6 border-b border-gray-100 flex text-[9px] text-gray-400 pt-1 select-none">
                        <div v-for="i in 20" :key="i" class="flex-1 border-l border-gray-200 pl-1">
                            +{{ (i - 1) * 100 }}ms
                        </div>
                    </div>
                    <div class="mt-8 px-2 space-y-1">
                        <div class="flex items-center gap-2 text-[10px] text-gray-600">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                            <i class="fas fa-wave-square text-[10px]"></i>
                            <span>action/</span>
                        </div>
                        <div class="h-2 w-full flex gap-[1px]">
                            <div v-for="i in 100" :key="i" class="flex-1 rounded-sm" :class="i > 40 && i < 50 ? 'bg-blue-500' : 'bg-gray-200'"></div>
                        </div>
                    </div>
                    <div class="absolute top-0 h-full w-[1px] bg-red-500 z-10" :style="{ left: viewerCursorPercent + '%' }">
                        <div class="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[6px] border-t-red-500 -ml-[3.5px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="auth.show" class="fixed inset-0 bg-black/40 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold">API 登录</h3>
                <button @click="auth.show = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <input v-model="auth.username" type="text" placeholder="用户名" class="w-full border rounded-lg px-3 py-2 text-sm">
                <input v-model="auth.password" type="password" placeholder="密码" class="w-full border rounded-lg px-3 py-2 text-sm">
                <input v-model="apiBase" type="text" placeholder="API Base URL" class="w-full border rounded-lg px-3 py-2 text-sm">
            </div>
            <div v-if="auth.error" class="text-xs text-red-500">{{ auth.error }}</div>
            <button @click="login" class="w-full py-2 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">登录</button>
        </div>
    </div>

    <div v-if="dataset.show" class="fixed inset-0 bg-black/40 flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold">添加数据集</h3>
                <button @click="dataset.show = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <input v-model="dataset.path" type="text" placeholder="数据集路径，例如 D:/lerobot_data/dataset-3" class="w-full border rounded-lg px-3 py-2 text-sm">
                <input v-model="dataset.robot" type="text" placeholder="机器人类型（可选，留空按目录名自动识别）" class="w-full border rounded-lg px-3 py-2 text-sm">
                <input v-model="dataset.taskType" type="text" placeholder="任务类型（可选，留空按目录名自动识别）" class="w-full border rounded-lg px-3 py-2 text-sm">
                <p class="text-xs text-slate-500">支持目录名格式：{robot_type}_{task_name}_{YYYY-MM-DD}。留空机器人/任务将自动识别；手动填写会覆盖自动识别结果。</p>
            </div>
            <div v-if="dataset.message" class="text-xs text-slate-600 bg-slate-100 rounded-lg p-3">
                {{ dataset.message }}
            </div>
            <button @click="registerDataset" class="w-full py-2 rounded-lg bg-slate-900 text-white text-sm hover:bg-slate-800" :disabled="dataset.working">
                {{ dataset.working ? '提交中...' : '开始索引' }}
            </button>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            apiBase: localStorage.getItem('apiBase') || 'http://localhost:8899',
            token: localStorage.getItem('token') || '',
            user: JSON.parse(localStorage.getItem('user') || 'null'),
            robots: [],
            taskTypes: [],
            datasets: [],
            items: [],
            total: 0,
            page: 1,
            pageSize: 50,
            search: '',
            selectedRobot: null,
            selectedTask: null,
            selectedDataset: null,
            viewMode: 'datasets',
            selectedItem: null,
            selectedCamera: null,
            detail: null,
            loading: {
                robots: false,
                items: false,
                detail: false,
            },
            auth: {
                show: false,
                username: 'admin',
                password: 'admin',
                error: ''
            },
            dataset: {
                show: false,
                path: '',
                robot: '',
                taskType: '',
                message: '',
                taskId: null,
                working: false,
                poller: null
            },
            viewer: {
                open: false,
                primaryCamera: null,
                secondaryCamera: null,
                actionData: [],
                stateData: [],
                actionNames: [],
                stateNames: [],
                timestamps: [],
                windowSeconds: 10,
                currentTime: 0
            },
            rerunMessage: ''
        };
    },
    computed: {
        filteredItems() {
            if (!this.search) return this.items;
            const q = this.search.toLowerCase();
            return this.items.filter(item => {
                return (
                    (item.episodeId || '').toLowerCase().includes(q) ||
                    (item.robot || '').toLowerCase().includes(q) ||
                    (item.taskType || '').toLowerCase().includes(q)
                );
            });
        },
        filteredDatasets() {
            if (!this.search) return this.datasets;
            const q = this.search.toLowerCase();
            return this.datasets.filter(ds => {
                return (
                    (ds.name || '').toLowerCase().includes(q) ||
                    (ds.robot || '').toLowerCase().includes(q) ||
                    (ds.taskType || '').toLowerCase().includes(q)
                );
            });
        },
        displayTotal() {
            return this.viewMode === 'datasets' ? this.filteredDatasets.length : this.total;
        },
        pageStart() {
            return this.total === 0 ? 0 : (this.page - 1) * this.pageSize + 1;
        },
        pageEnd() {
            return Math.min(this.page * this.pageSize, this.total);
        },
        isMobile() {
            return window.innerWidth < 1024;
        },
        videoUrl() {
            if (!this.selectedItem || !this.selectedCamera) return '';
            return `${this.apiBase}/items/${this.selectedItem.id}/stream?camera=${this.selectedCamera}`;
        },
        viewerCursorPercent() {
            return 50;
        },
        viewerCursorX() {
            return this.viewerCursorPercent;
        }
    },
    methods: {
        chipClass(active) {
            return active
                ? 'bg-blue-600 text-white border-blue-600 shadow'
                : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300';
        },
        formatBytes(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            let val = bytes;
            while (val >= 1024 && i < units.length - 1) {
                val /= 1024;
                i++;
            }
            return `${val.toFixed(1)} ${units[i]}`;
        },
        formatDuration(seconds) {
            if (!seconds) return '0s';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins ? `${mins}m ${secs}s` : `${secs}s`;
        },
        handleImageError(event) {
            event.target.src = `${this.apiBase}/static/episode-placeholder.svg`;
        },
        openAuth() {
            this.auth.show = true;
            this.auth.error = '';
        },
        openDatasetModal() {
            if (!this.token) {
                this.openAuth();
                return;
            }
            this.dataset.show = true;
            this.dataset.message = '';
        },
        async login() {
            this.auth.error = '';
            try {
                this.apiBase = this.normalizeApiBase(this.apiBase);
                const res = await fetch(`${this.apiBase}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: this.auth.username,
                        password: this.auth.password
                    })
                });
                if (!res.ok) throw new Error('登录失败');
                const data = await res.json();
                this.token = data.access_token;
                this.user = data.user;
                localStorage.setItem('token', this.token);
                localStorage.setItem('user', JSON.stringify(this.user));
                localStorage.setItem('apiBase', this.apiBase);
                this.auth.show = false;
                await this.bootstrap();
            } catch (err) {
                this.auth.error = err.message || '登录失败';
            }
        },
        logout() {
            this.token = '';
            this.user = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            this.openAuth();
        },
        async registerDataset() {
            if (!this.dataset.path) {
                this.dataset.message = '请填写数据集路径';
                return;
            }
            this.dataset.working = true;
            this.dataset.message = '正在提交索引任务...';
            try {
                this.apiBase = this.normalizeApiBase(this.apiBase);
                const res = await fetch(`${this.apiBase}/datasets/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: JSON.stringify({
                        path: this.dataset.path,
                        robot: this.dataset.robot || null,
                        task_type: this.dataset.taskType || null
                    })
                });
                if (!res.ok) {
                    const text = await res.text();
                    if (res.status === 404) {
                        throw new Error('接口未找到，请检查 API Base 是否为 http://localhost:8899');
                    }
                    throw new Error(text || '提交失败');
                }
                const data = await res.json();
                this.dataset.taskId = data.taskId;
                this.dataset.message = `索引任务已启动（任务ID: ${data.taskId}）`;
                this.pollIndexStatus();
            } catch (err) {
                this.dataset.message = err.message || '提交失败';
            } finally {
                this.dataset.working = false;
            }
        },
        async pollIndexStatus() {
            if (!this.dataset.taskId) return;
            try {
                const data = await this.apiFetch(`${this.apiBase}/index/status?task_id=${this.dataset.taskId}`);
                if (data.status === 'completed') {
                    this.dataset.message = '索引完成，正在刷新列表...';
                    await this.fetchRobots();
                    await this.fetchTaskTypes();
                    await this.fetchDatasets();
                    if (this.viewMode === 'episodes' && this.selectedDataset) {
                        await this.fetchItems();
                    }
                    this.dataset.message = '索引完成';
                    return;
                }
                if (data.status === 'failed') {
                    this.dataset.message = `索引失败：${data.errorMessage || '未知错误'}`;
                    return;
                }
                this.dataset.message = `索引中：${data.progress || 0}%`;
                setTimeout(() => this.pollIndexStatus(), 2000);
            } catch (err) {
                this.dataset.message = err.message || '索引状态查询失败';
            }
        },
        async apiFetch(url) {
            this.apiBase = this.normalizeApiBase(this.apiBase);
            const headers = this.token ? { 'Authorization': `Bearer ${this.token}` } : {};
            const res = await fetch(url, { headers });
            if (res.status === 401) {
                this.openAuth();
                throw new Error('未授权');
            }
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || '请求失败');
            }
            return res.json();
        },
        normalizeApiBase(value) {
            if (!value) return 'http://localhost:8899';
            let base = value.trim();
            base = base.replace(/\/+$/, '');
            if (base.endsWith('/api')) {
                base = base.slice(0, -4);
            }
            return base || 'http://localhost:8899';
        },
        async bootstrap() {
            await this.fetchRobots();
            await this.fetchTaskTypes();
            await this.fetchDatasets();
        },
        async fetchRobots() {
            this.loading.robots = true;
            try {
                const data = await this.apiFetch(`${this.apiBase}/robots`);
                this.robots = data.robots || [];
            } finally {
                this.loading.robots = false;
            }
        },
        async fetchTaskTypes() {
            const data = await this.apiFetch(`${this.apiBase}/task-types`);
            this.taskTypes = data.taskTypes || [];
        },
        async fetchItems() {
            this.loading.items = true;
            try {
                if (!this.selectedDataset) {
                    this.items = [];
                    this.total = 0;
                    return;
                }
                const params = new URLSearchParams({
                    page: this.page,
                    page_size: this.pageSize
                });
                const data = await this.apiFetch(`${this.apiBase}/datasets/${this.selectedDataset.id}/items?${params.toString()}`);
                this.items = data.items || [];
                this.total = data.total || 0;
            } finally {
                this.loading.items = false;
            }
        },
        async fetchDatasets() {
            this.loading.items = true;
            try {
                const params = new URLSearchParams();
                if (this.selectedRobot) params.append('robot', this.selectedRobot.name);
                if (this.selectedTask) params.append('type', this.selectedTask.name);
                const data = await this.apiFetch(`${this.apiBase}/datasets?${params.toString()}`);
                this.datasets = data.datasets || [];
            } finally {
                this.loading.items = false;
            }
        },
        async selectDataset(dataset) {
            this.selectedDataset = dataset;
            this.viewMode = 'episodes';
            this.page = 1;
            this.search = '';
            this.selectedItem = null;
            this.detail = null;
            await this.fetchItems();
        },
        async backToDatasets() {
            this.viewMode = 'datasets';
            this.selectedDataset = null;
            this.page = 1;
            this.items = [];
            this.total = 0;
            this.selectedItem = null;
            this.detail = null;
            await this.fetchDatasets();
        },
        async refreshDatasets() {
            this.page = 1;
            await this.fetchDatasets();
        },
        async selectRobot(robot) {
            this.selectedRobot = robot;
            this.selectedDataset = null;
            this.viewMode = 'datasets';
            this.page = 1;
            this.selectedItem = null;
            this.detail = null;
            await this.fetchDatasets();
        },
        async selectTask(task) {
            this.selectedTask = task;
            this.selectedDataset = null;
            this.viewMode = 'datasets';
            this.page = 1;
            this.selectedItem = null;
            this.detail = null;
            await this.fetchDatasets();
        },
        async selectItem(item) {
            this.selectedItem = item;
            this.selectedCamera = null;
            this.rerunMessage = '';
            await this.loadItemDetail();
            this.openViewer();
        },
        closeDetail() {
            this.selectedItem = null;
            this.detail = null;
        },
        async loadItemDetail() {
            if (!this.selectedItem) return;
            this.loading.detail = true;
            try {
                const detail = await this.apiFetch(`${this.apiBase}/items/${this.selectedItem.id}`);
                this.detail = detail;
                const cameras = detail.cameras || [];
                if (cameras.length) {
                    const preferred = cameras.find(cam => cam.cameraKey === 'top' || cam.cameraKey.toLowerCase().includes('top'));
                    this.selectedCamera = (preferred || cameras[0]).cameraKey;
                }
                this.resolveViewerCameras(detail);
            } finally {
                this.loading.detail = false;
            }
        },
        resolveViewerCameras(detail) {
            const cameras = detail?.cameras || [];
            if (!cameras.length) {
                this.viewer.primaryCamera = null;
                this.viewer.secondaryCamera = null;
                return;
            }
            const primary = cameras.find(cam => cam.cameraKey === 'top' || cam.cameraKey.toLowerCase().includes('top')) || cameras[0];
            let secondary = cameras.find(cam => cam.cameraKey.toLowerCase().includes('wrist'));
            if (!secondary) {
                secondary = cameras.find(cam => cam.cameraKey !== primary.cameraKey) || null;
            }
            this.viewer.primaryCamera = primary?.cameraKey || null;
            this.viewer.secondaryCamera = secondary?.cameraKey || null;
        },
        openViewer() {
            this.viewer.open = true;
            this.viewer.actionData = [];
            this.viewer.stateData = [];
            this.viewer.actionNames = [];
            this.viewer.stateNames = [];
            this.viewer.currentTime = 0;
            this.loadTimeseries();
        },
        closeViewer() {
            this.viewer.open = false;
        },
        async loadTimeseries() {
            if (!this.selectedItem) return;
            try {
                const data = await this.apiFetch(`${this.apiBase}/items/${this.selectedItem.id}/timeseries?max_points=300`);
                const timestamps = data.timestamps || [];
                const action = data.action || [];
                const state = data.state || [];
                this.viewer.actionNames = data.actionNames || [];
                this.viewer.stateNames = data.stateNames || [];
                this.viewer.timestamps = timestamps;
                this.viewer.actionData = action.map((arr, idx) => ({
                    time: timestamps[idx] ?? idx,
                    values: arr || []
                }));
                this.viewer.stateData = state.map((arr, idx) => ({
                    time: timestamps[idx] ?? idx,
                    values: arr || []
                }));
            } catch (err) {
                this.viewer.actionData = [];
                this.viewer.stateData = [];
                this.viewer.timestamps = [];
            }
        },
        chartPoints(seriesKey, valueIndex) {
            const data = seriesKey === 'action' ? this.viewer.actionData : this.viewer.stateData;
            if (!data.length) return '';
            const values = data.map(point => (point.values[valueIndex] ?? 0));
            const min = Math.min(...values);
            const max = Math.max(...values);
            const span = max - min || 1;

            const times = this.viewer.timestamps || [];
            const totalSpan = times.length ? ((times[times.length - 1] ?? 0) - (times[0] ?? 0)) : 1;
            const windowSeconds = Math.min(totalSpan || 1, this.viewer.windowSeconds || totalSpan || 1);
            const half = windowSeconds / 2;
            const center = this.viewer.currentTime;

            const points = [];
            for (let i = 0; i < data.length; i++) {
                const t = data[i].time ?? i;
                if (t < center - half || t > center + half) continue;
                const x = ((t - (center - half)) / windowSeconds) * 100;
                const y = 100 - (((data[i].values[valueIndex] ?? 0) - min) / span) * 100;
                points.push(`${x.toFixed(2)},${y.toFixed(2)}`);
            }
            return points.join(' ');
        },
        videoUrlFor(cameraKey) {
            if (!this.selectedItem || !cameraKey) return '';
            return `${this.apiBase}/items/${this.selectedItem.id}/stream?camera=${cameraKey}`;
        },
        onPrimaryTimeUpdate(event) {
            this.viewer.currentTime = event.target.currentTime || 0;
        },
        formatTimestamp(seconds) {
            const total = Number(seconds || 0);
            const mins = Math.floor(total / 60);
            const secs = Math.floor(total % 60);
            const ms = Math.floor((total - Math.floor(total)) * 1000);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
        },
        switchCamera(cameraKey) {
            this.selectedCamera = cameraKey;
        },
        async changePage(delta) {
            const next = this.page + delta;
            if (next < 1) return;
            this.page = next;
            this.selectedItem = null;
            this.detail = null;
            await this.fetchItems();
        },
        async generateRrd() {
            if (!this.selectedItem) return;
            this.rerunMessage = '正在生成 .rrd 文件，请稍候...';
            try {
                const res = await fetch(`${this.apiBase}/items/${this.selectedItem.id}/visualize/rrd`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: JSON.stringify({ format: 'rrd' })
                });
                if (!res.ok) throw new Error('生成失败');
                const data = await res.json();
                this.rerunMessage = `已生成：${data.downloadUrl}`;
            } catch (err) {
                this.rerunMessage = err.message || '生成失败';
            }
        },
        async startRerunServer() {
            if (!this.selectedItem) return;
            this.rerunMessage = '正在启动 Rerun 服务器...';
            try {
                const res = await fetch(`${this.apiBase}/items/${this.selectedItem.id}/visualize/server`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: JSON.stringify({ mode: 'distant', ws_port: 9087, web_port: 9090 })
                });
                if (!res.ok) throw new Error('启动失败');
                const data = await res.json();
                this.rerunMessage = `服务已启动：${data.wsUrl}`;
            } catch (err) {
                this.rerunMessage = err.message || '启动失败';
            }
        }
    },
    mounted() {
        this.apiBase = this.normalizeApiBase(this.apiBase);
        if (this.token) {
            this.bootstrap();
        } else {
            this.openAuth();
        }
    }
}).mount('#app');
</script>
</body>
</html>
