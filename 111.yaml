openapi: 3.0.3
info:
  title: Frontend API Spec (Full ~66 Endpoints)
  version: 1.0.0
servers:
  - url: https://api.example.com

tags:
  - name: Auth
  - name: Datasets
  - name: Items
  - name: Trash
  - name: Stats
  - name: Analytics
  - name: Naming
  - name: Schemas
  - name: Ingest
  - name: Records
  - name: ETL
  - name: External

security:
  - bearerAuth: []

paths:
  # -------------------------
  # Auth
  # -------------------------
  /auth/login:
    post:
      tags: [Auth]
      summary: 用户登录
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LoginRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthTokenResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /auth/refresh:
    post:
      tags: [Auth]
      summary: 刷新 token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RefreshTokenRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthTokenResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /auth/me:
    get:
      tags: [Auth]
      summary: 获取当前用户信息
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Datasets
  # -------------------------
  /datasets:
    get:
      tags: [Datasets]
      summary: 获取数据集列表
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: keyword
          in: query
          required: false
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedDatasets" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [Datasets]
      summary: 创建数据集
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DatasetCreateRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Dataset" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /datasets/{datasetId}:
    get:
      tags: [Datasets]
      summary: 获取单个数据集详情
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Dataset" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Datasets]
      summary: 更新数据集
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DatasetUpdateRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Dataset" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Datasets]
      summary: 删除数据集（软删除）
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /datasets/parse-lerobot:
    post:
      tags: [Datasets]
      summary: 解析 Lerobot 文件
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ParseLerobotRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ParseLerobotResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /datasets/create-lerobot:
    post:
      tags: [Datasets]
      summary: 创建 Lerobot 数据集
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateLerobotDatasetRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Dataset" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Items
  # -------------------------
  /datasets/{datasetId}/items:
    get:
      tags: [Items]
      summary: 获取数据项列表
      parameters:
        - $ref: "#/components/parameters/DatasetId"
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedItems" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /datasets/{datasetId}/upload:
    post:
      tags: [Items]
      summary: 上传文件到数据集
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items: { type: string, format: binary }
              required: [files]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UploadResult" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /datasets/{datasetId}/generate-test-data:
    post:
      tags: [Items]
      summary: 生成测试数据
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: "#/components/schemas/GenerateTestDataRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenerateTestDataResponse" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /items/{itemId}:
    get:
      tags: [Items]
      summary: 获取单个数据项详情
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Item" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Items]
      summary: 删除数据项（软删除/进入回收站，取决于后端实现）
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /items/{itemId}/preview:
    get:
      tags: [Items]
      summary: 获取数据项预览信息
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ItemPreview" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /items/{itemId}/download:
    get:
      tags: [Items]
      summary: 获取数据项下载 URL
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DownloadLink" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  # -------------------------
  # Trash (前端版路径)
  # -------------------------
  /trash:
    get:
      tags: [Trash]
      summary: 获取最近删除列表（统一回收站）
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [dataset, item, record]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedTrashEntries" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /trash/stats:
    get:
      tags: [Trash]
      summary: 获取回收站统计数据
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TrashStats" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /datasets/{datasetId}/restore:
    post:
      tags: [Trash]
      summary: 恢复数据集
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Dataset" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /items/{itemId}/restore:
    post:
      tags: [Trash]
      summary: 恢复数据项
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Item" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /datasets/batch-restore:
    post:
      tags: [Trash]
      summary: 批量恢复数据集
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchRestoreDatasetsRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /items/batch-restore:
    post:
      tags: [Trash]
      summary: 批量恢复数据项
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchRestoreItemsRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /datasets/{datasetId}/permanent:
    delete:
      tags: [Trash]
      summary: 永久删除数据集
      parameters:
        - $ref: "#/components/parameters/DatasetId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /items/{itemId}/permanent:
    delete:
      tags: [Trash]
      summary: 永久删除数据项
      parameters:
        - $ref: "#/components/parameters/ItemId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /datasets/batch-permanent:
    delete:
      tags: [Trash]
      summary: 批量永久删除数据集
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchPermanentDeleteDatasetsRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /items/batch-permanent:
    delete:
      tags: [Trash]
      summary: 批量永久删除数据项
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchPermanentDeleteItemsRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Stats / Analytics
  # -------------------------
  /stats:
    get:
      tags: [Stats]
      summary: 获取统计数据
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PlatformStats" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /analytics/task-status:
    get:
      tags: [Analytics]
      summary: 获取任务状态分布
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/StatusCount" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /analytics/skills:
    get:
      tags: [Analytics]
      summary: 获取技能使用统计
      parameters:
        - name: days
          in: query
          required: false
          description: 统计天数（如 7 或 30）
          schema: { type: integer, default: 7 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  days: { type: integer }
                  skills:
                    type: array
                    items: { $ref: "#/components/schemas/SkillUsage" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /analytics/items:
    get:
      tags: [Analytics]
      summary: 获取物品交互统计
      parameters:
        - name: operation_type
          in: query
          required: false
          description: 操作类型
          schema:
            type: string
            enum: [grabbed, recognized, failed]
            default: grabbed
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  operation_type: { type: string }
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/ItemStats" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Naming
  # -------------------------
  /naming/check:
    get:
      tags: [Naming]
      summary: 检查命名规范（批量检查页面使用）
      parameters:
        - name: standard
          in: query
          required: false
          schema:
            type: string
            enum: [general, lerobot, vue]
            default: general
        - name: scope
          in: query
          required: false
          schema:
            type: string
            enum: [all, src, dataset]
            default: all
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/NamingCheckBatchResponse" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /naming/rules/{standard}:
    get:
      tags: [Naming]
      summary: 获取命名规范规则
      parameters:
        - name: standard
          in: path
          required: true
          schema: { type: string, example: default }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/NamingRulesResponse" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /naming/validate:
    post:
      tags: [Naming]
      summary: 验证单个名称（通用）
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NamingValidateFileNameRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/NamingValidateResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /naming/validate/dataset:
    post:
      tags: [Naming]
      summary: 验证数据集名称
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NamingValidateRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/NamingValidateResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /naming/validate/data-item:
    post:
      tags: [Naming]
      summary: 验证数据项名称
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/NamingValidateDataItemRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/NamingValidateResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Schemas (v1)
  # -------------------------
  /v1/schemas:
    get:
      tags: [Schemas]
      summary: 获取所有 Schema 模板
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Schema" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [Schemas]
      summary: 创建 Schema 模板
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SchemaCreateRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Schema" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/schemas/{id}:
    get:
      tags: [Schemas]
      summary: 获取单个 Schema 详情
      parameters:
        - $ref: "#/components/parameters/SchemaId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Schema" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Schemas]
      summary: 更新 Schema 模板
      parameters:
        - $ref: "#/components/parameters/SchemaId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SchemaUpdateRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Schema" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Schemas]
      summary: 删除 Schema 模板
      parameters:
        - $ref: "#/components/parameters/SchemaId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/schemas/{schemaId}/fields:
    get:
      tags: [Schemas]
      summary: 获取表单字段结构
      parameters:
        - $ref: "#/components/parameters/SchemaIdAsSchemaId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/SchemaField" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  # -------------------------
  # Ingest (v1)
  # -------------------------
  /v1/ingest/manual:
    post:
      tags: [Ingest]
      summary: 提交手动录入数据
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/IngestManualRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Record" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/ingest/batch:
    post:
      tags: [Ingest]
      summary: 批量上传文件（采集）
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                schemaId:
                  type: integer
                  format: int64
                datasetId:
                  type: integer
                  format: int64
                files:
                  type: array
                  items: { type: string, format: binary }
              required: [schemaId, datasetId, files]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchIngestResult" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  # -------------------------
  # Records
  # -------------------------
  /v1/records:
    get:
      tags: [Records]
      summary: 分页查询数据记录
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: schemaId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: datasetId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: keyword
          in: query
          required: false
          schema: { type: string }
        - name: includeDeleted
          in: query
          required: false
          schema: { type: boolean, default: false }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedRecords" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/records/export:
    get:
      tags: [Records]
      summary: 导出数据记录
      parameters:
        - name: schemaId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: datasetId
          in: query
          required: false
          schema: { type: integer, format: int64 }
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [csv, json, xlsx]
            default: csv
      responses:
        "200":
          description: OK (file or link)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ExportLink" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/records/batch-delete:
    post:
      tags: [Records]
      summary: 批量删除数据记录
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/BatchIdsRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BatchResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/records/{id}:
    get:
      tags: [Records]
      summary: 获取单条数据详情
      parameters:
        - $ref: "#/components/parameters/RecordId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Record" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Records]
      summary: 更新数据记录
      parameters:
        - $ref: "#/components/parameters/RecordId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RecordUpdateRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Record" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Records]
      summary: 删除数据记录（软删除）
      parameters:
        - $ref: "#/components/parameters/RecordId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/records/{id}/validation:
    get:
      tags: [Records]
      summary: 获取数据校验对照视图
      parameters:
        - $ref: "#/components/parameters/RecordId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RecordValidationView" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/records/{id}/validate:
    post:
      tags: [Records]
      summary: 校验数据记录
      parameters:
        - $ref: "#/components/parameters/RecordId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RecordValidateResult" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/records/{id}/restore:
    post:
      tags: [Records]
      summary: 恢复已删除的数据记录
      parameters:
        - $ref: "#/components/parameters/RecordId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Record" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  # -------------------------
  # ETL Tasks
  # -------------------------
  /v1/etl/tasks:
    get:
      tags: [ETL]
      summary: 获取所有 ETL 任务
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
        - name: enabled
          in: query
          required: false
          schema: { type: boolean }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedEtlTasks" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [ETL]
      summary: 创建 ETL 任务
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/EtlTaskCreateRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/EtlTask" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /v1/etl/tasks/{id}:
    get:
      tags: [ETL]
      summary: 获取单个 ETL 任务详情
      parameters:
        - $ref: "#/components/parameters/EtlTaskId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/EtlTask" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [ETL]
      summary: 更新 ETL 任务
      parameters:
        - $ref: "#/components/parameters/EtlTaskId"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/EtlTaskUpdateRequest" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/EtlTask" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [ETL]
      summary: 删除 ETL 任务
      parameters:
        - $ref: "#/components/parameters/EtlTaskId"
      responses:
        "204":
          description: No Content
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/etl/tasks/{id}/toggle:
    put:
      tags: [ETL]
      summary: 启用/禁用 ETL 任务
      parameters:
        - $ref: "#/components/parameters/EtlTaskId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enabled: { type: boolean }
              required: [enabled]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/EtlTask" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/etl/tasks/{id}/run:
    post:
      tags: [ETL]
      summary: 手动触发 ETL 任务执行
      parameters:
        - $ref: "#/components/parameters/EtlTaskId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/EtlRun" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  /v1/etl/tasks/{taskId}/runs:
    get:
      tags: [ETL]
      summary: 获取 ETL 任务执行历史
      parameters:
        - name: taskId
          in: path
          required: true
          schema: { type: integer, format: int64 }
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedEtlRuns" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  # -------------------------
  # External ingest API
  # -------------------------
  /api/v1/ingest:
    post:
      tags: [External]
      summary: Ingest API（供外部脚本调用）
      description: 建议使用 apiKeyAuth 或独立鉴权；此处同时支持 bearerAuth 和 apiKeyAuth
      security:
        - bearerAuth: []
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ExternalIngestRequest" }
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ExternalIngestResponse" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    Page:
      name: page
      in: query
      required: false
      schema: { type: integer, minimum: 1, default: 1 }
    PageSize:
      name: page_size
      in: query
      required: false
      schema: { type: integer, minimum: 1, maximum: 200, default: 20 }

    DatasetId:
      name: datasetId
      in: path
      required: true
      schema: { type: integer, format: int64 }
    ItemId:
      name: itemId
      in: path
      required: true
      schema: { type: integer, format: int64 }
    SchemaId:
      name: id
      in: path
      required: true
      schema: { type: integer, format: int64 }
    SchemaIdAsSchemaId:
      name: schemaId
      in: path
      required: true
      schema: { type: integer, format: int64 }
    RecordId:
      name: id
      in: path
      required: true
      schema: { type: integer, format: int64 }
    EtlTaskId:
      name: id
      in: path
      required: true
      schema: { type: integer, format: int64 }

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
    NotFound:
      description: Not Found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }

  schemas:
    # ---------- Common ----------
    Error:
      type: object
      properties:
        code: { type: string, example: BAD_REQUEST }
        message: { type: string, example: invalid parameter }
        details:
          type: object
          additionalProperties: true
      required: [code, message]

    BatchIdsRequest:
      type: object
      properties:
        ids:
          type: array
          items: { type: integer, format: int64 }
      required: [ids]

    BatchRestoreDatasetsRequest:
      type: object
      properties:
        dataset_ids:
          type: array
          items: { type: string }
      required: [dataset_ids]

    BatchRestoreItemsRequest:
      type: object
      properties:
        item_ids:
          type: array
          items: { type: string }
      required: [item_ids]

    BatchPermanentDeleteDatasetsRequest:
      type: object
      properties:
        dataset_ids:
          type: array
          items: { type: string }
      required: [dataset_ids]

    BatchPermanentDeleteItemsRequest:
      type: object
      properties:
        item_ids:
          type: array
          items: { type: string }
      required: [item_ids]

    BatchResult:
      type: object
      properties:
        successCount: { type: integer, example: 3 }
        failedCount: { type: integer, example: 1 }
        failedIds:
          type: array
          items: { type: integer, format: int64 }
      required: [successCount, failedCount]

    # ---------- Auth ----------
    LoginRequest:
      type: object
      properties:
        username: { type: string, example: admin }
        password: { type: string, example: "******" }
      required: [username, password]

    RefreshTokenRequest:
      type: object
      properties:
        refresh_token: { type: string }
      required: [refresh_token]

    AuthTokenResponse:
      type: object
      properties:
        access_token: { type: string }
        refresh_token: { type: string }
        expires_in: { type: integer, example: 7200 }
        user: { $ref: "#/components/schemas/User" }
      required: [access_token, user]

    User:
      type: object
      properties:
        id: { type: integer, format: int64 }
        username: { type: string }
        displayName: { type: string }
        roles:
          type: array
          items: { type: string }
      required: [id, username]

    # ---------- Dataset / Item ----------
    Dataset:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        description: { type: string, nullable: true }
        item_count: { type: integer, example: 10 }
        total_size_bytes: { type: integer, format: int64, example: 1048576 }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        created_by: { type: string, nullable: true }
        is_deleted: { type: boolean, nullable: true }
        deleted_at: { type: string, format: date-time, nullable: true }
        deleted_by: { type: string, nullable: true }
      required: [id, name, created_at, updated_at]

    DatasetCreateRequest:
      type: object
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
      required: [name]

    DatasetUpdateRequest:
      type: object
      properties:
        name: { type: string }
        description: { type: string, nullable: true }

    PagedDatasets:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/Dataset" }
      required: [page, page_size, total, data]

    Item:
      type: object
      properties:
        id: { type: string }
        dataset_id: { type: string }
        filename: { type: string }
        content_type: { type: string, nullable: true }
        size_bytes: { type: integer, format: int64 }
        deleted_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
      required: [id, dataset_id, filename, size_bytes, created_at]

    PagedItems:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/Item" }
      required: [page, page_size, total, data]

    ItemPreview:
      type: object
      properties:
        itemId: { type: integer, format: int64 }
        thumbnailUrl: { type: string }
        meta:
          type: object
          additionalProperties: true
      required: [itemId]

    DownloadLink:
      type: object
      properties:
        itemId: { type: integer, format: int64 }
        url: { type: string }
        expiresAt: { type: string, format: date-time, nullable: true }
      required: [itemId, url]

    UploadResult:
      type: object
      properties:
        uploaded: { type: integer, example: 3 }
        items:
          type: array
          items: { $ref: "#/components/schemas/Item" }
      required: [uploaded, items]

    GenerateTestDataRequest:
      type: object
      properties:
        count: { type: integer, default: 10 }
      additionalProperties: false

    GenerateTestDataResponse:
      type: object
      properties:
        generated: { type: integer }
      required: [generated]

    ParseLerobotRequest:
      type: object
      properties:
        sourceUrl: { type: string, nullable: true }
        path: { type: string, nullable: true }
      description: 二选一提供 sourceUrl 或 path
      additionalProperties: true

    ParseLerobotResponse:
      type: object
      properties:
        ok: { type: boolean }
        meta:
          type: object
          additionalProperties: true
      required: [ok]

    CreateLerobotDatasetRequest:
      type: object
      properties:
        name: { type: string }
        parseResult:
          type: object
          additionalProperties: true
      required: [name]

    # ---------- Trash ----------
    TrashEntry:
      type: object
      properties:
        type: { type: string, enum: [dataset, item, record] }
        id: { type: integer, format: int64 }
        name: { type: string, nullable: true }
        deletedAt: { type: string, format: date-time }
      required: [type, id, deletedAt]

    PagedTrashEntries:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/TrashEntry" }
      required: [page, page_size, total, data]

    TrashStats:
      type: object
      properties:
        datasetDeleted: { type: integer }
        itemDeleted: { type: integer }
        recordDeleted: { type: integer }
      required: [datasetDeleted, itemDeleted, recordDeleted]

    # ---------- Stats / Analytics ----------
    PlatformStats:
      type: object
      properties:
        dataset_count: { type: integer }
        item_count: { type: integer }
        total_size_gb: { type: number }
        recent_count: { type: integer }
      required: [dataset_count, item_count, total_size_gb]

    StatusCount:
      type: object
      properties:
        status: { type: string }
        count: { type: integer }
      required: [status, count]

    SkillUsage:
      type: object
      properties:
        skill: { type: string }
        count: { type: integer }
      required: [skill, count]

    ItemStats:
      type: object
      properties:
        name: { type: string }
        count: { type: integer }
      required: [name, count]

    ItemInteractionStats:
      type: object
      properties:
        grasped: { type: integer }
        recognized: { type: integer }
        failed: { type: integer }
      required: [grasped, recognized, failed]

    # ---------- Naming ----------
    NamingCheckResponse:
      type: object
      properties:
        enabled: { type: boolean, example: true }
        defaultStandard: { type: string, example: default }
      required: [enabled]

    NamingCheckBatchResponse:
      type: object
      properties:
        issues:
          type: array
          items: { $ref: "#/components/schemas/NamingIssue" }
        stats: { $ref: "#/components/schemas/NamingStats" }
      required: [issues, stats]

    NamingIssue:
      type: object
      properties:
        type: { type: string, enum: [error, warning] }
        rule: { type: string }
        message: { type: string }
        current: { type: string }
        suggested:
          type: array
          items: { type: string }
          nullable: true
      required: [type, rule, message, current]

    NamingStats:
      type: object
      properties:
        total: { type: integer }
        valid: { type: integer }
        warnings: { type: integer }
        errors: { type: integer }
      required: [total, valid, warnings, errors]

    NamingRulesResponse:
      type: object
      properties:
        standard: { type: string }
        rules:
          type: array
          items: { type: string }
      required: [standard, rules]

    NamingValidateRequest:
      type: object
      properties:
        name: { type: string }
      required: [name]

    NamingValidateFileNameRequest:
      type: object
      properties:
        fileName: { type: string }
        standard: { type: string }
      required: [fileName, standard]

    NamingValidateDataItemRequest:
      type: object
      properties:
        name: { type: string }
        schemaId: { type: string, nullable: true }
      required: [name]

    NamingValidateResponse:
      type: object
      properties:
        valid: { type: boolean }
        reason: { type: string, nullable: true }
        normalized: { type: string, nullable: true }
        suggested:
          type: array
          items: { type: string }
          nullable: true
        message: { type: string, nullable: true }
      required: [valid]

    # ---------- Schemas ----------
    Schema:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        description: { type: string, nullable: true }
        fields:
          type: array
          items: { $ref: "#/components/schemas/SchemaField" }
        created_at: { type: string, format: date-time }
      required: [id, name, fields]

    SchemaField:
      type: object
      properties:
        key: { type: string, example: sku }
        label: { type: string, nullable: true }
        type: { type: string, example: string }
        required: { type: boolean, default: false }
        options:
          type: array
          items: { type: string }
          nullable: true
      required: [key, type]

    SchemaCreateRequest:
      type: object
      properties:
        name: { type: string }
        category: { type: string }
        description: { type: string, nullable: true }
        fields:
          type: array
          items: { $ref: "#/components/schemas/SchemaField" }
      required: [name, category, fields]

    SchemaUpdateRequest:
      type: object
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
        fields:
          type: array
          items: { $ref: "#/components/schemas/SchemaField" }

    # ---------- Ingest / Records ----------
    IngestManualRequest:
      type: object
      properties:
        schemaId: { type: integer, format: int64 }
        datasetId: { type: integer, format: int64 }
        values:
          type: object
          additionalProperties: true
      required: [schemaId, datasetId, values]

    BatchIngestResult:
      type: object
      properties:
        createdRecords: { type: integer }
        createdItems: { type: integer }
      required: [createdRecords]

    Record:
      type: object
      properties:
        id: { type: string }
        schema_id: { type: string }
        dataset_id: { type: string }
        values:
          type: object
          additionalProperties: true
        status:
          type: string
          nullable: true
          example: valid
        deleted_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [id, schema_id, dataset_id, values, created_at, updated_at]

    RecordUpdateRequest:
      type: object
      properties:
        values:
          type: object
          additionalProperties: true
        status:
          type: string
          nullable: true

    PagedRecords:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/Record" }
      required: [page, page_size, total, data]

    RecordValidationView:
      type: object
      properties:
        recordId: { type: integer, format: int64 }
        expected:
          type: object
          additionalProperties: true
        actual:
          type: object
          additionalProperties: true
        diff:
          type: array
          items:
            type: object
            additionalProperties: true
      required: [recordId]

    RecordValidateResult:
      type: object
      properties:
        recordId: { type: integer, format: int64 }
        valid: { type: boolean }
        issues:
          type: array
          items: { type: string }
      required: [recordId, valid]

    ExportLink:
      type: object
      properties:
        url: { type: string }
        expiresAt: { type: string, format: date-time, nullable: true }
      required: [url]

    # ---------- ETL ----------
    EtlTask:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        enabled: { type: boolean, default: true }
        config:
          type: object
          additionalProperties: true
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        total_runs: { type: integer, nullable: true }
      required: [id, name, enabled, created_at, updated_at]

    EtlTaskCreateRequest:
      type: object
      properties:
        name: { type: string }
        enabled: { type: boolean, default: true }
        config:
          type: object
          additionalProperties: true
      required: [name, config]

    EtlTaskUpdateRequest:
      type: object
      properties:
        name: { type: string }
        enabled: { type: boolean }
        config:
          type: object
          additionalProperties: true

    EtlRun:
      type: object
      properties:
        id: { type: string }
        task_id: { type: string }
        status: { type: string, enum: [success, failed, running] }
        start_time: { type: string, format: date-time, nullable: true }
        end_time: { type: string, format: date-time, nullable: true }
        records_processed: { type: integer, nullable: true }
        error_message: { type: string, nullable: true }
      required: [id, task_id, status]

    PagedEtlTasks:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/EtlTask" }
      required: [page, page_size, total, data]

    PagedEtlRuns:
      type: object
      properties:
        page: { type: integer }
        page_size: { type: integer }
        total: { type: integer }
        data:
          type: array
          items: { $ref: "#/components/schemas/EtlRun" }
      required: [page, page_size, total, data]

    # ---------- External ----------
    ExternalIngestRequest:
      type: object
      properties:
        schemaId: { type: integer, format: int64 }
        datasetId: { type: integer, format: int64 }
        payload:
          type: object
          additionalProperties: true
      required: [schemaId, datasetId, payload]

    ExternalIngestResponse:
      type: object
      properties:
        accepted: { type: boolean }
        trackingId: { type: string }
      required: [accepted]